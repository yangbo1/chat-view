<!doctype html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/default.css">
<link rel="stylesheet" type="text/css" href="css/styles.css">
<script src="js/sockjs.js"></script>
<script src="js/core.js"></script>
<script src="js/jquery.min.js"></script>
</head>
<body>

<div id="chatbox" class="ui-mobile-viewport ui-overlay-c">
	<div id="friendslist">
		<div id="topmenu">
			<span class="friends"></span>
			<span class="chats"></span>
			<!--<span class="history"></span>-->
		</div>
		
		<div id="friends" style="height:414px;overflow:auto">
			<!--<div class="friend">-->
				<!--<img src="img/1_copy.jpg" />-->
				<!--<p>-->
					<!--<strong>haha</strong>-->
					<!--<span>mirobadev@gmail.com</span>-->
				<!--</p>-->
				<!--<div class="status available"></div>-->
			<!--</div>-->
			<!---->
			<!--<div class="friend">-->
				<!--<img src="img/2_copy.jpg" />-->
				<!--<p>-->
					<!--<strong>hehe</strong>-->
					<!--<span>marjoseph@gmail.com</span>-->
				<!--</p>-->
				<!--<div class="status away"></div>-->
			<!--</div>-->
			<!---->
			<!--<div class="friend">-->
				<!--<img src="img/3_copy.jpg" />-->
				<!--<p>-->
					<!--<strong>Tomas Kennedy</strong>-->
					<!--<span>tomaskennedy@gmail.com</span>-->
				<!--</p>-->
				<!--<div class="status inactive"></div>-->
			<!--</div>-->
			<!---->
			<!--<div class="friend">-->
				<!--<img src="img/4_copy.jpg" />-->
				<!--<p>-->
					<!--<strong>Enrique	Sutton</strong>-->
					<!--<span>enriquesutton@gmail.com</span>-->
				<!--</p>-->
				<!--<div class="status inactive"></div>-->
			<!--</div>-->
			<!---->
			<!--<div class="friend">-->
				<!--<img src="img/5_copy.jpg" />-->
				<!--<p>-->
				<!--<strong>	Darnell	Strickland</strong>-->
					<!--<span>darnellstrickland@gmail.com</span>-->
				<!--</p>-->
				<!--<div class="status inactive"></div>-->
			<!--</div>-->

			<!--<div id="search">-->
				<!--<input type="text" id="searchfield" value="Search contacts..." />-->
			<!--</div>-->
			
		</div>                

	</div>	
	
	<div id="chatview" class="p1">    	
		<div id="profile">

			<div id="close">
				<div class="cy"></div>
				<div class="cx"></div>
			</div>
			
			<p>Miro Badev</p>
			<span>miro@badev@gmail.com</span>
		</div>
		<div id="chat-messages">
			<!--<label>Thursday 02</label>-->
			<!---->
			<!--<div class="message">-->
				<!--<img src="img/1_copy.jpg" />-->
				<!--<div class="bubble">-->
					<!--Really cool stuff!-->
					<!--<div class="corner"></div>-->
					<!--<span>3 min</span>-->
				<!--</div>-->
			<!--</div>-->
			<!---->
			<!--<div class="message right">-->
				<!--<img src="img/2_copy.jpg" />-->
				<!--<div class="bubble">-->
					<!--Can you share a link for the tutorial?-->
					<!--<div class="corner"></div>-->
					<!--<span>1 min</span>-->
				<!--</div>-->
			<!--</div>-->
			<!---->
			<!--<div class="message">-->
				<!--<img src="img/1_copy.jpg" />-->
				<!--<div class="bubble">-->
					<!--Yeah, hold on-->
					<!--<div class="corner"></div>-->
					<!--<span>Now</span>-->
				<!--</div>-->
			<!--</div>-->
			<!---->
			<!--<div class="message right">-->
				<!--<img src="img/2_copy.jpg" />-->
				<!--<div class="bubble">-->
					<!--Can you share a link for the tutorial?-->
					<!--<div class="corner"></div>-->
					<!--<span>1 min</span>-->
				<!--</div>-->
			<!--</div>-->
			<!---->
			<!--<div class="message">-->
				<!--<img src="img/1_copy.jpg" />-->
				<!--<div class="bubble">-->
					<!--Yeah, hold on-->
					<!--<div class="corner"></div>-->
					<!--<span>Now</span>-->
				<!--</div>-->
			<!--</div>-->

			<!--<div class="message">-->
				<!--<img src="img/1_copy.jpg" />-->
				<!--<div class="bubble">-->
					<!--Yeah, hold on-->
					<!--<div class="corner"></div>-->
					<!--<span>Now</span>-->
				<!--</div>-->
			<!--</div>-->
			<!--<div class="message">-->
				<!--<img src="img/1_copy.jpg" />-->
				<!--<div class="bubble">-->
					<!--Yeah, hold on-->
					<!--<div class="corner"></div>-->
					<!--<span>Now</span>-->
				<!--</div>-->
			<!--</div>-->

			<!--<div class="message">-->
				<!--<img src="img/1_copy.jpg" />-->
				<!--<div class="bubble">-->
					<!--Yeah, hold on-->
					<!--<div class="corner"></div>-->
					<!--<span>Now</span>-->
				<!--</div>-->
			<!--</div>-->
			<!--<div class="message">-->
				<!--<img src="img/1_copy.jpg" />-->
				<!--<div class="bubble">-->
					<!--Yeah, hold on-->
					<!--<div class="corner"></div>-->
					<!--<span>Now</span>-->
				<!--</div>-->
			<!--</div>-->
		<!--</div>-->
		<!---->
		</div>
		<div id="sendmessage">
			<input type="text" placeholder="Send message..." id="message"/>
			<button id="send"></button>
		</div>
	

	</div>
</div>


<script language="javascript">
    function sc(){
        var div = document.getElementById("chat-messages");
//        div.innerText += "\n" + (i++).toString(); //可以不要
        div.scrollTop = div.scrollHeight;
    }
</script>
<script>
	var chatNotes = [];
	var selfImg = "";
	var onlineFriends = [];
	var hehefs = [
		{
		    name: "haha",
			img: "img/haha.jpg",
			sign: "im haha"
		},
		{
		    name: "aaa",
			img: "img/aaa.jpg",
			sign: "im aaa"
		}
	]
	var hahafs = [
		{
		    name: "hehe",
			img: "img/hehe.jpg",
			sign: "im hehe"
		}
	]
	var aaafs = [
		{
		    name: "hehe",
			img: "img/hehe.jpg",
			sign: "im hehe"
		}
	]

    function getParam(paramName) {
        paramValue = "";
        isFound = false;
        if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=") > 1) {
            arrSource = unescape(this.location.search).substring(1, this.location.search.length).split("&");
            i = 0;
            while (i < arrSource.length && !isFound) {
                if (arrSource[i].indexOf("=") > 0) {
                    if (arrSource[i].split("=")[0].toLowerCase() == paramName.toLowerCase()) {
                        paramValue = arrSource[i].split("=")[1];
                        isFound = true;
                    }
                }
                i++;
            }
        }
        return paramValue;
    }
    var user = getParam("user");
	var nowName = "";
    function ready() {
        var preloadbg = document.createElement('img');
        preloadbg.src = 'img/timeline1.png';
        $('#searchfield').focus(function () {
            if ($(this).val() == 'Search contacts...') {
                $(this).val('');
            }
        });
        $('#searchfield').focusout(function () {
            if ($(this).val() == '') {
                $(this).val('Search contacts...');
            }
        });
        $('#sendmessage input').focus(function () {
            if ($(this).val() == 'Send message...') {
                $(this).val('');
            }
        });
        $('#sendmessage input').focusout(function () {
            if ($(this).val() == '') {
                $(this).val('Send message...');
            }
        });
        $('.friend').each(function () {
            $(this).click(function () {
                var childOffset = $(this).offset();
                var parentOffset = $(this).parent().parent().offset();
                var childTop = childOffset.top - parentOffset.top;
                var clone = $(this).find('img').eq(0).clone();
                var top = childTop + 12 + 'px';
                $(clone).css({ 'top': top }).addClass('floatingImg').appendTo('#chatbox');
                setTimeout(function () {
                    $('#profile p').addClass('animate');
                    $('#profile').addClass('animate');
                }, 100);
                setTimeout(function () {
                    $('#chat-messages').addClass('animate');
                    $('.cx, .cy').addClass('s1');
                    setTimeout(function () {
                        $('.cx, .cy').addClass('s2');
                    }, 100);
                    setTimeout(function () {
                        $('.cx, .cy').addClass('s3');
                    }, 200);
                }, 150);
                $('.floatingImg').animate({
                                              'width': '68px',
                                              'left': '42%',
                                              'top': '20px'
                                          }, 200);
                var name = $(this).find('p strong').html();
                var email = $(this).find('p span').html();
                $('#profile p').html(name);
                $('#profile span').html(email);

                $('.message').not('.right').find('img').attr('src', $(clone).attr('src'));
                $('#friendslist').fadeOut();
                $('#chat-messages').empty();
                $('#chat-messages').append(chatNotes[name]);
                nowName = name;
                $('#chatview').fadeIn();
                //让聊天窗口滚动到底部
                sc();
                $('#close').unbind('click').click(function () {
                    nowName = "";
                    $('#chat-messages, #profile, #profile p').removeClass('animate');
                    $('.cx, .cy').removeClass('s1 s2 s3');
                    $('.floatingImg').animate({
                                                  'width': '40px',
                                                  'top': top,
                                                  'left': '12px'
                                              }, 200, function () {
                        $('.floatingImg').remove();
                    });
                    setTimeout(function () {
                        $('#chatview').fadeOut();
                        $('#friendslist').fadeIn();
                    }, 50);
                });

            });
        });
    }
	$(document).ready(function () {
//	user = Page.URL.getParameter("user");
//	ready();
});

	var wsServer = null;
	var ws = null;
	wsServer = config.url.server+ user;
	ws = new WebSocket(wsServer); //创建WebSocket对象
	if (ws == null) {
	    alert("aaa")
	}
	ws.onopen = function (evt) {
	    console.log(evt)
		addFriendList(evt.data);

//		layer.msg("已经建立连接", { offset: 0});
	};
	ws.onmessage = function (evt) {
        console.log(evt)
		analysisMessage(evt.data);  //解析后台传回的消息,并予以展示
	};
	ws.onerror = function (evt) {
        console.log(evt)
//		layer.msg("产生异常", { offset: 0});
		window.location.href = "user/login.html"
	};
	ws.onclose = function (evt) {
        console.log(evt)
        window.location.href = "user/login.html"
//		layer.msg("已经关闭连接", { offset: 0});
//        alert("连接已断开")
	};
	//
    function addFriendList(data) {
//    var friend1 = "<div class='friend'>" +
//               		"<img src='img/1_copy.jpg'/>" +
//                        "<p>" +
//							"<strong>haha</strong>"+
//						   "<span>mirobadev@gmail.com</span>" +
//						"</p>" +
//						"<div class='status available'></div>" +
//				   "</div>";
//        var friend2 = "<div class='friend'>" +
//                     "<img src='img/2_copy.jpg'/>" +
//                     "<p>" +
//                     "<strong>hehe</strong>"+
//                     "<span>fuck</span>" +
//                     "</p>" +
//                     "<div class='status available'></div>" +
//                     "</div>";

//        $("#friends").empty();
		if (data) {
            var friend = "";
            for (var i = 0; i < data.length; i ++) {
                if ($.inArray(data[i].name, onlineFriends) != -1){

				} else {
                    friend +=  "<div class='friend' id='f"+data[i].name+"'>" +
                               "<img src='"+data[i].img+"'/>" +
                               "<p>" +
                               "<strong>"+data[i].name+"</strong>"+
                               "<span>("+data[i].remark+")</span>" +
                               "</p>" +
                               "<div class='status available'></div>" +
                               "</div>";
                    onlineFriends.push(data[i].name)
				}

            }
            $("#friends").append(friend)
		}

//        if (user == "hehe") {
//
//            for (var i = 0; i < hehefs.length; i ++) {
//				friend +=  "<div class='friend'>" +
//                              "<img src='"+hehefs[i].img+"'/>" +
//                              "<p>" +
//                              "<strong>"+hehefs[i].name+"</strong>"+
//                              "<span>"+hehefs[i].sign+"</span>" +
//                              "</p>" +
//                              "<div class='status available'></div>" +
//                              "</div>";
//            }
//            $("#friends").append(friend)
//		}
//		if (user == "haha") {
//            for (var i = 0; i < hahafs.length; i ++) {
//                friend +=  "<div class='friend'>" +
//                           "<img src='"+hahafs[i].img+"'/>" +
//                           "<p>" +
//                           "<strong>"+hahafs[i].name+"</strong>"+
//                           "<span>"+hahafs[i].sign+"</span>" +
//                           "</p>" +
//                           "<div class='status available'></div>" +
//                           "</div>";
//            }
//            $("#friends").append(friend)
//		}
//		if (user == "aaa") {
//            for (var i = 0; i < aaafs.length; i ++) {
//                friend +=  "<div class='friend'>" +
//                           "<img src='"+aaafs[i].img+"'/>" +
//                           "<p>" +
//                           "<strong>"+aaafs[i].name+"</strong>"+
//                           "<span>"+aaafs[i].sign+"</span>" +
//                           "</p>" +
//                           "<div class='status available'></div>" +
//                           "</div>";
//            }
//            $("#friends").append(friend)
//		}
		ready();
    }
    function removeFriend(data) {
        if ($.inArray(data, onlineFriends) != -1) {
            $("#f"+data+"").remove();
            onlineFriends.splice($.inArray(data,onlineFriends),1);
            ready();
		}

    }
    /**
	 * 连接
	 */
	function getConnection(){
		if(ws == null){
			ws = new WebSocket(wsServer); //创建WebSocket对象
			ws.onopen = function (evt) {
//				layer.msg("成功建立连接!", { offset: 0});
				addFriendList(evt.data);
			};
			ws.onmessage = function (evt) {
				analysisMessage(evt.data);  //解析后台传回的消息,并予以展示
			};
			ws.onerror = function (evt) {
				layer.msg("产生异常", { offset: 0});
			};
			ws.onclose = function (evt) {
				layer.msg("已经关闭连接", { offset: 0});
			};
		}else{
			layer.msg("连接已存在!", { offset: 0, shift: 6 });
		}
	}

	/**
	 * 关闭连接
	 */
	function closeConnection(){
		if(ws != null){
			ws.close();
			ws = null;
			$("#list").html("");    //清空在线列表
			layer.msg("已经关闭连接", { offset: 0});
		}else{
			layer.msg("未开启连接", { offset: 0, shift: 6 });
		}
	}

	/**
	 * 检查连接
	 */
	function checkConnection(){
		if(ws != null){
			layer.msg(ws.readyState == 0? "连接异常":"连接正常", { offset: 0});
		}else{
			layer.msg("连接未开启!", { offset: 0, shift: 6 });
		}
	}
	$("#send").click(function () {
		sendMessage();
        $("#message").val("");
    })
    //为keyListener方法注册按键事件
    document.onkeydown=keyListener;
    function keyListener(e){
        // 当按下回车键，执行我们的代码
        if(e.keyCode == 13){
            //我们要做的事情
            sendMessage();
            $("#message").val("");
        }
    }
	/**
	 * 发送信息给后台
	 */
	function sendMessage(){
		if(ws == null){
			alert("连接失败");
			return;
		}
		var message = $("#message").val();
        var to = $('#profile p').html();
        console.log(to)
//		var to = $("#sendto").text() == "全体成员"? "": $("#sendto").text();
		if(message == null || message == ""){
			alert("请输入");
			return;
		}
//		$("#tuling").text() == "已上线"? tuling(message):console.log("图灵机器人未开启");  //检测是否加入图灵机器人
		ws.send(JSON.stringify({
								   message : {
									   content : message,
									   from : user,
									   to : to,      //接收人,如果没有则置空,如果有多个接收人则用,分隔
									   time : new Date().getTime()
								   },
								   type : "message"
							   }));
	}

	/**
	 * 解析后台传来的消息
	 * "massage" : {
		 *              "from" : "xxx",
		 *              "to" : "xxx",
		 *              "content" : "xxx",
		 *              "time" : "xxxx.xx.xx"
		 *          },
	 * "type" : {notice|message},
	 * "list" : {[xx],[xx],[xx]}
	 *
	 *     <div class="message">
				 <img src="img/1_copy.jpg" />
				 <div class="bubble">
				 Really cool stuff!
				 <div class="corner"></div>
				 <span>3 min</span>
				 </div>
			</div>

				 <div class="message right">
				 <img src="img/2_copy.jpg" />
				 <div class="bubble">
				 Can you share a link for the tutorial?
				 <div class="corner"></div>
				 <span>1 min</span>
				 </div>
				 </div>
	 */
	function analysisMessage(message){
		message = JSON.parse(message);
		if(message.type == "message"){      //会话消息
//			showChat(message.message);

			var data = message.message;
			var content = data.content;
			var to = data.to;
			var from = data.from;
			var time = timestampToTime(data.time);
            console.log(content,to,time)

			var left = "<br><label>"+time+"</label>"+
				"<div class='message'>" +
						   "<img src='"+selfImg+"' />"+
                "<span>"+from+"</span>" +
						   "<div class='bubble'>"+
						   	content +
							   "<div class='corner'></div>" +
//							   "<span>"+from +":"+ time +"</span>" +
						   "</div>" +
                       "</div>";

			var right = "<br><label>"+time+"</label>"+
				"<div class='message right'>" +
							  "<img src='"+selfImg+"' />"+
                "<span>"+from+"</span>" +
							   "<div class='bubble'>"+
							  		content +
									"<div class='corner'></div>" +
//								   "<span>"+from +":"+ time +"</span>" +
							   "</div>" +
					    "</div>";
            if (to == user) {
                if (nowName == from) {
                    $("#chat-messages").append(left);
                    var chatNote = $("#chat-messages").html();
                    chatNotes[from] = chatNote;
                } else {
                    var chatNote = chatNotes[from];
                    chatNote += left;
                    chatNotes[from] = chatNote;
				}

			} else if (from == user){
                $("#chat-messages").append(right);
                var chatNote = $("#chat-messages").html();
                chatNotes[to] = chatNote;
            }
		}else if (message.type == "id"){
		    var id = message.id
            selfImg = message.img;
		    var online = message.online;
		    console.log(online)
			$.ajax({
				type: "POST",
				dataType: "json",
				url: config.url.frineds ,
			    traditional: true,
				data: {
                    "online": online,
                    "self": user
                },
				success: function (data) {
//					console.log(data)
                    addFriendList(data)
                }
				   })
		} else if (message.type == "off"){
			console.log(message)
			removeFriend(message.message)
		}
		//让聊天窗口滚动到底部
		sc();
		if(message.type == "notice"){       //提示消息
//			showNotice(message.message);
		}
		if(message.list != null && message.list != undefined){      //在线列表
//			showOnline(message.list);
		}
	}
    function timestampToTime(timestamp) {
        var date = new Date(timestamp).toLocaleTimeString();//时间戳为10位需*1000，时间戳为13位的话不需乘1000
//        Y = date.getFullYear() + '-';
//        M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
//        D = date.getDate() + ' ';
//        h = date.getHours() + ':';
//        m = date.getMinutes() + ':';
//        s = date.getSeconds();
//        return Y+M+D+h+m+s;
		return date;
    }
//    timestampToTime(1403058804);
//    console.log(timestampToTime(1403058804));//2014-06-18 10:33:24
</script>

</body>
</html>
